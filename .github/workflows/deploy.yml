name: Deploy Homelab

on:
  push:
    branches:
      - "tests/internet"

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      # 1. O Runner baixa o código na pasta isolada dele
      - name: Checar Código
        uses: actions/checkout@v3
        with:
          clean: false 

      # 2. Configura Node.js no ambiente do Runner
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. Instala dependências (No ambiente do Runner)
      - name: Instalar Dependências
        run: |
          npm install

      # 4. Gera o Build do React (No ambiente do Runner)
      # Isso cria a pasta 'dist' com a versão nova do site
      - name: Buildar Frontend
        run: |
          npm run build:react

      # --- PASSO CRÍTICO: DEPLOY REAL ---
      # 5. Copia os arquivos gerados do Runner para a pasta que o Nginx/PM2 usam
      - name: Deploy para Pasta de Produção
        run: |
          # Usa rsync para sincronizar os arquivos
          # -a: modo arquivo (preserva permissões)
          # -v: verbose (mostra o que está fazendo)
          # --exclude: não copia a pasta .git, node_modules ou .github
          rsync -av --progress . /home/ocnaibill/concord --exclude .git --exclude node_modules --exclude .github

          # Entra na pasta de produção e garante que as dependências do backend estejam lá
          cd /home/ocnaibill/concord
          npm install --production

      # 6. Reinicia o Servidor Backend
      - name: Reiniciar Backend (PM2)
        run: |
          # Reinicia o processo PM2 pelo nome
          # Se falhar (processo não existe), inicia ele do zero apontando para o arquivo correto
          pm2 restart concord-server || pm2 start /home/ocnaibill/concord/server/main.js --name concord-server
          
          # Salva a lista para garantir que volte se o servidor reiniciar
          pm2 save